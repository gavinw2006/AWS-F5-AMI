
ssh -i "GW-AWS-SYDNEY.pem" ubuntu@3.104.217.142

cat << EOF > config.yaml
NO_UPLOAD: "Yes"
BOOT_LOCATIONS: "1" 
MODULES: "all" 
PLATFORM: "aws"
REUSE: "Yes"
ISO: "/mnt/BIGIP-15.1.5-0.0.10.iso"
IMAGE_DIR: "/mnt/images"
EOF


export AWS_ACCESS_KEY_ID=AKIAQKEK6GVR2ISF3MUQ
export AWS_SECRET_ACCESS_KEY=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
export AWS_DEFAULT_REGION=ap-southeast-2



{
   "Version": "2012-10-17",
   "Statement": [
      {
         "Effect": "Allow",
         "Principal": { "Service": "vmie.amazonaws.com" },
         "Action": "sts:AssumeRole",
         "Condition": {
            "StringEquals":{
               "sts:Externalid": "vmimport"
            }
         }
      }
   ]
}

aws iam create-role --role-name vmimport --assume-role-policy-document "file://trust-policy.json"



{
   "Version":"2012-10-17",
   "Statement":[
      {
         "Effect": "Allow",
         "Action": [
            "s3:GetBucketLocation",
            "s3:GetObject",
            "s3:ListBucket" 
         ],
         "Resource": [
            "arn:aws:s3:::gw-abgmbh",
            "arn:aws:s3:::gw-abgmbh/*"
         ]
      },
      {
         "Effect": "Allow",
         "Action": [
            "s3:GetBucketLocation",
            "s3:GetObject",
            "s3:ListBucket",
            "s3:PutObject",
            "s3:GetBucketAcl"
         ],
         "Resource": [
            "arn:aws:s3:::gw-abgmbh",
            "arn:aws:s3:::gw-abgmbh/*"
         ]
      },
      {
         "Effect": "Allow",
         "Action": [
            "ec2:ModifySnapshotAttribute",
            "ec2:CopySnapshot",
            "ec2:RegisterImage",
            "ec2:Describe*"
         ],
         "Resource": "*"
      }
   ]
}

aws iam put-role-policy --role-name vmimport --policy-name vmimport --policy-document "file://role-policy.json"

aws ec2 import-snapshot --disk-container "file://vmdk.json"

aws ec2 describe-import-snapshot-tasks --import-task-ids import-snap-0f44af7fad3270366

/f5/src/lib/python/image

cat aws_image.py

  try:
            response = self.ec2_client.register_image(
                Architecture="x86_64",
                BlockDeviceMappings=[
                    {
                        "DeviceName": AWSImage.AWS_IMAGE_ROOT_VOLUME,
                        "Ebs":
                        {
                            "DeleteOnTermination": True,
                            "SnapshotId": self.snapshot.snapshot_id,
                            "VolumeType": "gp2"
                        }
                    }cd 
                ],
                EnaSupport=True,
                Description=image_name,
                Name=image_name,
                RootDeviceName=AWSImage.AWS_IMAGE_ROOT_VOLUME,
                SriovNetSupport="simple",
                VirtualizationType="hvm"
                )


